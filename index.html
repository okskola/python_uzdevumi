<!DOCTYPE html>
<html lang="lv">
    <head>
        <meta charset="utf-8">
        <title>Python uzevumi</title>
        <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
        <!--<script defer src="https://pyscript.net/latest/pyscript.js"></script> load only when button pressed so I can load page without waiting for python-->
        <script src="ace/ace.js"></script>
        <script src="ace/ext-language_tools.js"></script>
        <style>
            #code {
                min-width: 500px;
                min-height: 300px;
            }
            button {
                margin: 5px 0 5px 0;
            }
        </style>
    </head>
    <body>
        <h1>Python uzdevumi</h1>
        Izvēlies uzdevumu <select name="tasks" id="tasks" onchange="newTask();">
            <option value=""></option>
        </select>
        <div style="border: 1px solid black;">
            Uzdevuma teksts: <span id="task"></span>
        </div>

        <div style="border: 1px solid blue;" id="code">print("Hello, World!")</div>
        <button id="btnRun"    onclick="run();" disabled>Izpildīt (Ctrl+Enter)</button>
        <button id="btnPython" onclick="loadPyhon();">Ieslēgt Python</button>
        <div style="border: 1px solid black;">Te tiks izvadīti dati</div>
        <!--
        <py-script output="output" style="border: 1px solid red;">
        </py-script>
        -->

        <script>
            var editor = ace.edit("code");
            editor.setTheme("ace/theme/chrome");
            editor.session.setMode("ace/mode/python");
            ace.require("ace/ext/language_tools");
            editor.setOptions({
                enableBasicAutocompletion: true
            });
        </script>

        <script>
            // load config and tasks
                    // old idea from https://www.freecodecamp.org/news/how-to-read-json-file-in-javascript/
                    //fetch('./python_uzdevumi.json')
                    //    .then((response) => response.json())
                    //    .then((json) => console.log(json));
            // idea from https://dmitripavlutin.com/fetch-with-json/
            var tasksList;
            async function loadConfig() {
                var response = await fetch('./python_uzdevumi.json');
                var config = await response.json();
                tasksList = config["tasks"];
                //console.log(config);
                // add tasks to combobox
                sel = document.getElementById('tasks');
                //console.log( config["tasks"] );
                i = 0;
                for (var t of tasksList){
                    //console.log( t );
                    var opt = document.createElement('option');
                    //opt.value = t["id"];
                    opt.value = i++;
                    opt.innerHTML = t["name"];
                    sel.appendChild(opt);
                }
            }
            loadConfig();

            // user selected a task
            function newTask() {
                var taskInd = document.getElementById("tasks").value;
                document.getElementById("task").innerHTML = tasksList[taskInd]["task"];
                editor.getSession().setValue(tasksList[taskInd]["code"], -1)
            }

            // load py-script (if its loaded togherer with page, it makes loading of page really slow)
            var pyScriptLoaded = false;
            function loadPyhon(){
                if (!pyScriptLoaded) {
                    var script = document.createElement("script");
                    script.type = "text/javascript";
                    script.src = "https://pyscript.net/latest/pyscript.js";
                    document.getElementsByTagName("head")[0].appendChild(script);
                    pyScriptLoaded = true;
                }
                document.getElementById("btnRun").disabled = false;
                document.getElementById("btnPython").disabled = true;
            }

            // catch Ctrl+Enter to execute code
            document.getElementById("code").addEventListener("keydown", keyPressed);
            function keyPressed(e){
                if (e.keyCode === 13 && e.ctrlKey && pyScriptLoaded) {
                    run();
                    e.preventDefault();
                }
            }

            // input emulation
            function input(text) {
                return "abc";
            }

            // Ideas from:
            //  https://www.jhanley.com/blog/pyscript-create-the-py-script-tag-at-runtime/
            //  https://community.anaconda.cloud/t/executing-dynamically-created-pyscript/21327/5
            var pyScriptTag;
            if (pyScriptTag) {
                pyScriptTag.remove();
            }
            function run() {

                // clean output tag
                document.getElementById("output").innerHTML = "";
                // get the code to execute
                var codeToRun = editor.getSession().getValue()
                // create a py-script tag and execute it
                var div = document.createElement("div");
                div.innerHTML = "<py-script output='output' style='border: 1px solid green;'>"+
                "from js import input\n"+
                codeToRun+"</py-script>";
//alert( div.innerHTML );
                var pyScriptTag = div.firstElementChild;
                document.body.appendChild(pyScriptTag);
                try {
                    //alert( pyScriptTag.outerHTML );
                    pyScriptTag.evaluate();
                } catch (error) {
                    console.error("Python error:");
                    console.error(error);
                }
            }
        </script>

    </body>
</html>
